const defaultConfig = require("@wordpress/scripts/config/webpack.config");
const RemoveEmptyScriptsPlugin = require("webpack-remove-empty-scripts");
const path = require("path");
const glob = require("glob");
const fs = require("fs");

// theme.json variables
const themeJson = require("../theme.json");
const themeSettings = themeJson.settings;
const prefix = themeSettings.custom.themePrefix;

// Generate color palette from theme.json
const paletteArray = themeSettings.color.palette;
const getFormattedPalette = (paletteArray) => {
	const slugList = paletteArray.map((entry) => `"${entry.slug}"`);
	return `$color-palette: (${slugList.join(", ")})`;
};
const colorPalette = getFormattedPalette(paletteArray);
const colors = require("../theme.json").settings.color.palette;
// Saves our theme.json variables to a separate sass file that will be forwarded by our utils
const themeVariables = `
  // This file is auto-generated by webpack.config.js
  // Do not modify this file directly
  $theme-prefix: "${prefix}" !default;
  $block-prefix: "wp-block-${prefix}" !default;
  ${colorPalette} !default;
`;

const generatedDir = path.join(__dirname, "src/styles/utils");
const generatedFilePath = path.join(generatedDir, "_theme.generated.scss");

// Ensure the directory exists
if (!fs.existsSync(generatedDir)) {
	fs.mkdirSync(generatedDir, { recursive: true });
}

// Write the file to disk
fs.writeFileSync(generatedFilePath, themeVariables, "utf8");

// Creates separate entrypoints for each page template
const pageTemplates = glob
	.sync("./src/scripts/page-templates/*.js")
	.reduce((files, path) => {
		const name = path
			.split("/")
			.pop()
			.replace(/\.[^]+$/, "");
		return { ...files, [name]: path };
	}, {});

/**
 * Function to dynamically create Webpack entry points.
 * It scans for .js and .scss files within the ./kraken-core/ directory structure
 * and groups them by their base name (e.g., editor.js and editor.scss become one entry).
 *
 * @returns {Object} The entry points object for Webpack.
 */
const getKrakenAssets = () => {
	const entries = {};
	// Find all js and scss files in the specified directory structure.
	const files = glob.sync("./src/kraken-core/**/!(_)*.{js,scss}");

	files.forEach((file) => {
		// Create a clean entry name from the file path, without the extension.
		// e.g., ./kraken-core/block-name/editor.js -> kraken-core/block-name/editor
		const entryName = path
			.relative(".", file)
			.replace(/\.(js|scss)$/, "")
			.replace(/\\/g, "/");
		// If an entry for this name doesn't exist, create it as an array.
		if (!entries[entryName]) {
			entries[entryName] = [];
		}
		// Add the file to the entry array.
		entries[entryName].push(file);
	});

	return entries;
};

module.exports = {
	...defaultConfig,
	resolve: {
		...defaultConfig.resolve,
		alias: {
			...defaultConfig.alias,
			scripts: path.resolve(__dirname, "src/scripts/"),
			styles: path.resolve(__dirname, "src/styles/"),
			fonts: path.resolve(__dirname, "fonts/"),
			images: path.resolve(__dirname, "images/"),
		},
	},
	module: {
		...defaultConfig.module,
		rules: [
			...defaultConfig.module.rules,
			{
				test: /\.js/,
				loader: "import-glob",
			},
			{
				test: /\.s[ac]ss$/i,
				use: [
					{
						loader: "sass-loader",
						options: {
							api: "modern-compiler",
							additionalData: `@use "styles/utils" as *;`,
							implementation: require("sass-embedded"),
							sassOptions: {
								includePaths: [path.resolve(__dirname, "src")],
							},
						},
					},
				],
			},
		],
	},
	entry: {
		...defaultConfig.entry(),
		admin: "./src/scripts/admin.js",
		gutenberg: "./src/scripts/gutenberg/gutenberg.js",
		app: "./src/scripts/app.js",
		...pageTemplates,
		...getKrakenAssets(),
	},
	output: {
		...defaultConfig.output,
		filename: "./[name].js",
		publicPath: "../build/",
	},
	plugins: [
		// Include WP's plugin config.
		...defaultConfig.plugins,
		// Removes the empty `.js` files generated by webpack but
		// sets it after WP has generated its `*.asset.php` file.
		new RemoveEmptyScriptsPlugin({
			stage: RemoveEmptyScriptsPlugin.STAGE_AFTER_PROCESS_PLUGINS,
		}),
	],
};
